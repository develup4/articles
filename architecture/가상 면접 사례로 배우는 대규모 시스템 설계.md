# 사용자 수에 따른 규모 확장성

## 데이터베이스

### No SQL

아래와 같은 경우에는 비관계형 데이터베이스가 바람직한 선택일 수 있다.

- 아주 낮은 응답 지연시간이 요구됨
- 다루는 데이터가 비정형이라 관계형 데이터가 아님
- 데이터(JSON, YAML, XML 등)를 직렬화하거나 역직렬화 할 수 있기만 하면 됨
- 아주 많은 양의 데이터를 저장할 필요가 있음

### 데이터베이스 다중화

쓰기 연산(Write Operation)은 마스터에서만 지원한다.

### 샤딩(Sharding)

샤딩은 대규모 데이터베이스를 샤드(Shard)라고 부르는 작은 단위로 분할하는 기술을 일컫는다. 모든 샤드는 같은 스키마를 쓰지만 샤드에 보관되는 데이터 사이에는 중복이 없다.

## 단일 장애 지점(Single Point of Failure, SPOF)

어떤 **특정 지점에서의 장애가 전체 시스템의 동작을 중단**시켜버릴 수 있는 경우, 우리는 해당 지점을 `단일 장애 지점`이라 부른다.

## 무상태 웹 계층

웹 계층을 **수평적으로 확장**하는 방법을 고민해 볼 순서다. 이를 위해서는 **상태 정보(사용자 세션 데이터와 같은)를 웹 계층에서 제거**하여아 한다. 바람직한 전략은 상태 정보를 관계형 데이터베이스나 NoSQL같은 지속성 저장소에 보관하고, 필요할 때 가져오도록 하는 것이다. 이렇게 구성된 웹 계층을 `무상태 웹 계층`이라 부른다.

## 메시지 큐

메시지 큐는 메시지의 무손실(durability, 즉 메시지 큐에 일단 보관된 메시지는 소비자가 꺼낼 때까지 안전히 보관된다는 특성)을 보장하는, 비동기 통신(Asynchronous Communication)을 지원하는 컴포넌트다.

## 백만 사용자, 그리고 그 이상

시스템의 규모를 확장하는 것은 지속적이고 반복적(Iterative)인 과정이다. 시스템 규모 확장을 위해 살펴본 기법들을 정리해보면 아래와 같다.

- 웹 계층은 무상태 계층으로
- 모든 계층에 다중화 도입
- 가능한 한 많은 데이터를 캐시할 것
- 여러 데이터 센터를 지원할 것
- 정적 콘텐츠는 CDN을 통해 서비스할 것
- 데이터 계층은 샤딩을 통해 그 규모를 확장할 것
- 각 계층은 독립적 서비스로 분할할 것
- 시스템을 지속적으로 모니터링하고, 자동화 도구들을 활용할 것

![IMG_6141.heic](BigSystem/IMG_6141.heic)

# 시스템 설계 면접

## 개략적인 규모 추정

시스템 설계 면접을 볼 때, 때로는 시스템 용량이나 성능 요구사항을 개략적으로 추정해 보라는 요구를 받게 된다.

- 메모리는 빠르지만 디스크는 아직도 느리다.
- 디스크 탐색은 가능한 피하라
- 단순한 압축 알고리즘은 빠르다.
- 데이터를 인터넷으로 전송하기 전에 가능하면 압축하라.
- 데이터 센터는 보통 여러 지역(Region)에 분산되어 있고, 센터들 간에 데이터를 주고받는데는 시간이 걸린다.

## 요구사항 파악을 위한 질문

- 구체적으로 어떤 기능들을 만들어야 하나?
- 제품 사용자 수는 얼마나 되나?
- 회사의 규모는 얼마나 빨리 커지리라 예상하나? 석 달, 여섯 달, 일년 뒤에 규모는 얼마가 되리리 예상하는가?
- 회사가 주로 사용하는 기술 스택은 무엇인가? 설계를 단순화하기 위해 활용할 수 있는 기존 서비스로는 어떤 것들이 있는가?

# 처리율 제한 장치의 설계

## 예시

- 사용자는 초당 2회 이상 새 글을 올릴 수 없다.
- 같은 IP 주소로는 하루에 10개 이상의 계정을 생성할 수 없다.
- 같은 디바이스로는 주당 5회 이상 리워드를 요청할 수 없다.

### 마이크로 서비스의 경우

처리율 제한 장치는 보통 **API 게이트웨이**라고 불리는 컴포넌트에 구현된다. API 게이트웨이는 처리율 제한, SSL 종단, 사용자 인증, IP 허용목록 관리 등을 지원하는 완전 위탁관리형 서비스(Fully Managed)이다. 즉, 클라우드 업체가 유지 보수를 담당하는 서비스이다.

## 장점

- DoS(Denial of Service) 공격에 의한 자원 고갈을 방지할 수 있다. 대형 IT 기업들이 공개한 거의 대부분의 API는 어떤 형태로든 처리율 제한 장치를 갖고 있다.
- 비용을 절감한다.
- 서버 과부하를 막는다.

# 안정 해시 설계

수평적 규모 확장성을 달성하기 위해서는 요청 또는 데이터를 서버에 균등하게 나누는 것이 중요하다.

## 해시 키 재배치 문제

서버들에 부하를 균등하게 나누는 보편적 방법은 아래 해시 함수를 사용하는 것이다.

<aside>
💡 serverIndex = hash(key) % N

</aside>

하지만 예를 들어 1번 서버에 장애가 생긴다면 분포가 달라져 대규모의 **캐시 미스(Cache Miss)**가 발생하게 될 것이다. 안정 해시는 이 문제를 효과적으로 해결하는 기술이다.

### 안정 해시 사례

- 아마존 다이나모 데이터베이스의 파티셔닝 관련 컴포넌트
- 아파치 카산드라 클러스터에서의 데이터 파티셔닝
- 디스코드의 채팅 어플리케이션
- 아카마이 CDN
- 매그레프 네트워크 부하 분산기

# 키-값 저장소 설계

## CAP 정리

`데이터 일관성(Consistency)`, `가용성(Availability)`, `파티션 감내(Partition Tolerance)`라는 세 가지 요구사항을 동시에 만족하는 분산 시스템을 설계하는 것은 불가능하다는 정리이다.

- 데이터 일관성: 분산 시스템에 접속하는 모든 클라이언트는 어떤 노드에 접속했느냐에 관계없이 언제나 같은 데이터를 보게 되어야 한다.
- 가용성: 분산 시스템에 접속하는 클라이언트는 일부 노드에 장애가 발생하더라도 항상 응답을 받을 수 있어야 한다. 예를 들어 가용성 대신 일관성을 선택한다면 데이터 불일치 문제를 피하기 위해 쓰기 연산을 중단해야하는데 그러면 가용성이 깨진다. 예를 들어 은행권 시스템은 데이터 일관선을 양보하지 않는다.
- 파티션 감내: 파티션은 두 노드 사이에 통신 장애가 발생하였음을 의미한다. 파티션 감내는 네트워크에 파티션이 생기더라도 시스템은 계속 동작하여야 한다는 것을 뜻한다. **그러나 통산 네트워크 장애는 피할 수 없는 일로 여겨지므로, 분산 시스템은 반드시 파티션 문제를 감내할 수 있도록 설계되어야 한다. 그러므로 실세계에 CA 시스템은 존재하지 않는다.**

# 뉴스 피드 시스템 설계

## 포스팅 전송(팬아웃) 서비스

포스팅 전송, 즉 **팬아웃(Fanout)은 어떤 사용자의 새 포스팅을 그 사용자와 친구 관계에 있는 모든 사용자에게 전달하는 과정**이다. 팬아웃에는 두 가지 모델이 있는데 하나는 쓰기 시점에 `팬아웃(Fanout-on-Write)`하는 모델(Push 모델)이고, 다른 하나는 읽기 시점에 `팬아웃(Fanout-on-Read)`하는 모델(Pull 모델)이다.

뉴스 피드를 빠르게 가져올 수 있도록 하는 것은 아주 중요하므로 대부분 사용자에 대해서는 푸시 모델을 사용한다. 친구나 팔로워가 아주 많은 사용자의 경우에는 팔로어로 하여금 해당 사용자의 포스팅을 필요할 때 가져가도록 하는 풀 모델을 사용하여 시스템 과부하를 방지할 것이다.

![IMG_6142.heic](BigSystem/IMG_6142.heic)
